---
import Layout from "../layouts/Layout.astro";
import GeneratorForm from "../components/GeneratorForm.astro";
import ResultsDisplay from "../components/ResultsDisplay.astro";
---

<Layout title="商标大师起名">
	<div class="container main-layout">
		<div class="left-panel">
			<div class="glass-card sticky-card">
				<h1>商标大师</h1>
				<p class="subtitle">AI 智能驱动，一键探索优质品牌方案</p>
				<GeneratorForm />
			</div>
		</div>
		<div class="right-panel">
			<ResultsDisplay />
		</div>
	</div>

	<script>
		// TypeScript Interface for API Data
		interface Candidate {
			name: string;
			status: string;
			reason: string;
			query_url: string;
		}

		document.addEventListener("DOMContentLoaded", () => {
			const form = document.getElementById("generator-form") as HTMLFormElement;
			const industryInput = document.getElementById(
				"industry",
			) as HTMLInputElement;
			const keywordsInput = document.getElementById(
				"keywords",
			) as HTMLInputElement;
			const submitBtn = document.getElementById(
				"submit-btn",
			) as HTMLButtonElement;
			const resultsContainer = document.getElementById(
				"results-container",
			) as HTMLDivElement;
			const resultsList = document.getElementById(
				"results-list",
			) as HTMLDivElement;
			const errorContainer = document.getElementById(
				"error-container",
			) as HTMLDivElement;

			const emptyState = document.getElementById(
				"empty-state",
			) as HTMLDivElement;
			const thinkingContainer = document.getElementById(
				"thinking-container",
			) as HTMLDivElement;
			const thinkingContent = document.getElementById(
				"thinking-content",
			) as HTMLDivElement;
			const thinkingHeader = document.getElementById(
				"thinking-header",
			) as HTMLDivElement;
			const thinkingSpinner = document.getElementById(
				"thinking-spinner",
			) as HTMLDivElement;
			const thinkingStatusText = document.getElementById(
				"thinking-status-text",
			) as HTMLSpanElement;
			const thinkingToggleBtn = document.getElementById(
				"thinking-toggle-btn",
			) as HTMLButtonElement;

			thinkingHeader.addEventListener("click", () => {
				thinkingHeader.classList.toggle("collapsed");
			});

			// 适配本地开发与 Vercel 生产环境
			const isLocal =
				window.location.hostname === "localhost" ||
				window.location.hostname === "127.0.0.1";
			const API_URL = isLocal
				? "http://127.0.0.1:8000/api/v1/generate-names-stream"
				: "/api/v1/generate-names-stream";

			form.addEventListener("submit", async (e: Event) => {
				e.preventDefault();

				const industry = industryInput.value;
				const keywords = keywordsInput.value;

				// Reset state
				errorContainer.style.display = "none";
				resultsList.innerHTML = "";
				resultsContainer.classList.remove("visible");

				// Hide empty state
				emptyState.classList.remove("visible");
				emptyState.style.display = "none";

				thinkingContent.textContent = "";
				thinkingHeader.classList.remove("collapsed", "completed");
				thinkingSpinner.classList.remove("hidden");
				thinkingToggleBtn.classList.add("hidden");
				thinkingStatusText.textContent = "AI 正在思考中...";
				thinkingContainer.classList.add("visible");
				thinkingContainer.style.display = "block";

				submitBtn.disabled = true;
				submitBtn.classList.add("loading");

				const markThinkingCompleted = () => {
					thinkingHeader.classList.add("completed");
					thinkingSpinner.classList.add("hidden");
					thinkingToggleBtn.classList.remove("hidden");
					thinkingStatusText.textContent = "思考完成";
				};

				try {
					const response = await fetch(API_URL, {
						method: "POST",
						headers: {
							"Content-Type": "application/json",
						},
						body: JSON.stringify({ industry, keywords }),
					});

					if (!response.ok) {
						throw new Error(`请求失败 (状态码: ${response.status})`);
					}

					if (!response.body) throw new Error("ReadableStream not supported");

					const reader = response.body.getReader();
					const decoder = new TextDecoder();
					let buffer = "";

					while (true) {
						const { done, value } = await reader.read();
						if (done) break;

						buffer += decoder.decode(value, { stream: true });
						const lines = buffer.split("\n\n");
						buffer = lines.pop() || "";

						for (const line of lines) {
							if (line.startsWith("data: ")) {
								const dataStr = line.replace("data: ", "");
								try {
									const data = JSON.parse(dataStr);
									if (data.type === "reasoning") {
										thinkingContent.textContent += data.content;
										// Auto scroll to bottom if not collapsed
										if (!thinkingHeader.classList.contains("collapsed")) {
											thinkingContent.scrollTop = thinkingContent.scrollHeight;
										}
									} else if (data.type === "result") {
										markThinkingCompleted();

										if (data.error_msg) {
											showError(data.error_msg);
										}
										if (data.candidates && data.candidates.length > 0) {
											renderResults(data.candidates);
											resultsContainer.classList.add("visible");
										} else {
											showError(
												"未能生成有效的商标名称，大模型可能拒答了。请换个更常见的关键词重试。",
											);
										}
									} else if (data.type === "error") {
										markThinkingCompleted();
										showError(data.message);
									}
								} catch (e) {
									console.error("Error parsing SSE data line:", dataStr, e);
								}
							}
						}
					}
				} catch (err: unknown) {
					const errMsg = err instanceof Error ? err.message : String(err);
					markThinkingCompleted();
					showError(
						errMsg === "Failed to fetch"
							? "网络请求失败。请确保后台服务正在运行。"
							: errMsg,
					);
				} finally {
					submitBtn.disabled = false;
					submitBtn.classList.remove("loading");
				}
			});

			function renderResults(candidates: Candidate[]) {
				candidates.forEach((cand, index) => {
					const card = document.createElement("div");
					card.className = "result-card";
					// Stagger the slideUpFade animation based on index
					card.style.animationDelay = `${index * 0.15}s`;

					const isPass = cand.status === "pass";
					const statusBadge = isPass
						? `<span class="status-badge status-pass">可用方案</span>`
						: `<span class="status-badge status-fail">风险标记</span>`;

					card.innerHTML = `
            <div class="result-header">
              <div class="result-name">
                ${cand.name}
                ${statusBadge}
              </div>
            </div>
            <div class="result-reason">${cand.reason}</div>
            <div class="action-container">
              <a href="${cand.query_url}" target="_blank" rel="noopener noreferrer" class="action-link" title="前往阿里云查找是否有重名商标">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="11" cy="11" r="8"></circle>
                  <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
                阿里云查重
              </a>
            </div>
          `;
					resultsList.appendChild(card);
				});
			}

			function showError(msg: string) {
				errorContainer.textContent = msg;
				errorContainer.style.display = "block";
			}
		});
	</script>

	<style>
		.container {
			width: 100%;
			max-width: 1100px;
			margin: 0 auto;
			padding: 0 1.5rem 4rem;
		}

		.main-layout {
			display: grid;
			grid-template-columns: 1fr;
			gap: 2rem;
			align-items: start;
		}

		@media (min-width: 860px) {
			.main-layout {
				grid-template-columns: 380px 1fr;
				gap: 3rem;
			}
		}

		.sticky-card {
			position: sticky;
			top: 2rem;
		}

		.left-panel {
			width: 100%;
			z-index: 10;
		}

		.right-panel {
			width: 100%;
			min-height: 400px;
		}

		.glass-card {
			background: rgba(30, 41, 59, 0.6); /* Increased brightness for contrast */
			backdrop-filter: blur(24px) saturate(180%);
			-webkit-backdrop-filter: blur(24px) saturate(180%);
			border: 1px solid rgba(255, 255, 255, 0.1); /* Brighter border */
			border-radius: 24px;
			padding: 2.5rem 2rem;
			box-shadow:
				0 4px 6px -1px rgba(0, 0, 0, 0.1),
				0 24px 38px -10px rgba(0, 0, 0, 0.6),
				inset 0 1px 1px rgba(255, 255, 255, 0.1);
			animation: floatIn 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
		}

		@keyframes floatIn {
			0% {
				opacity: 0;
				transform: translateY(20px) scale(0.98);
			}
			100% {
				opacity: 1;
				transform: translateY(0) scale(1);
			}
		}

		h1 {
			font-size: 2.5rem;
			font-weight: 700;
			margin-bottom: 0.5rem;
			background: linear-gradient(135deg, #f8fafc 0%, #94a3b8 100%);
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
			text-align: left;
			line-height: 1.2;
		}

		p.subtitle {
			text-align: left;
			color: var(--text-muted);
			margin-bottom: 2.5rem;
			font-size: 0.95rem;
			line-height: 1.5;
		}
	</style>
</Layout>
